<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AiRez — Bookable Restaurants</title>
  <link rel="icon" href="logo.png" />
  <style>
    :root { --bg:#f7f8fb; --card:#fff; --ink:#0f172a; --muted:#6b7280; --line:#eef0f3; --brand:#0A61FF; --radius:14px; --shadow:0 10px 30px rgba(2,8,23,.08); font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;}
    *{box-sizing:border-box} html,body{margin:0;color:var(--ink);background:var(--bg)} a{color:var(--brand);text-decoration:none} a:hover{text-decoration:underline}
    .nav{height:64px;display:flex;align-items:center;padding:0 18px;background:#fff;border-bottom:1px solid var(--line)}
    .nav .brand{display:flex;align-items:center;gap:10px;font-weight:800} .nav .brand img{width:28px;height:28px;border-radius:6px}
    main{max-width:980px;margin:18px auto 80px;padding:0 16px}
    .hero{display:flex;flex-direction:column;align-items:center;gap:14px;text-align:center;margin:24px 0 8px}
    .hero-logo{width:220px;height:220px;object-fit:contain;filter:drop-shadow(0 16px 34px rgba(0,0,0,.12));border-radius:14px;background:#fff}
    h1{font-size:clamp(28px,4.2vw,44px);line-height:1.14;margin:0;font-weight:900;letter-spacing:-.015em}
    .subtitle{color:var(--muted);margin:0 auto;max-width:900px;font-size:clamp(14px,1.9vw,16px)}
    .chips{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin:16px 0 22px}
    .chip{font-size:13px;background:#fff;border:1px solid var(--line);padding:8px 12px;border-radius:999px;box-shadow:0 3px 10px rgba(0,0,0,.03)}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin:0 auto 18px}
    .row{display:grid;gap:10px;grid-template-columns:1.6fr 110px 160px 140px 180px 110px}
    .row>*{height:42px;padding:0 12px;border:1px solid #e4e7ec;border-radius:10px;outline:none;background:#fff}
    .btn{height:42px;border:0;border-radius:10px;background:#111;color:#fff;padding:0 16px;font-weight:700;cursor:pointer}
    .status{color:var(--muted);font-size:13px;margin-top:10px} #aiNote{margin-top:12px;color:#333;font-size:14px}

    #tabs{display:flex;gap:10px;margin:6px 0 12px}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#fff;color:#111;font-weight:700;cursor:pointer}
    .tab.active{background:#0A61FF;color:#fff;border-color:#0A61FF}

    #results .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:14px;margin:12px 0;box-shadow:0 6px 16px rgba(0,0,0,.04)}
    .title{font-weight:800;font-size:17px}.muted{color:var(--muted);font-size:13px}.links a{margin-right:12px;font-weight:600}.ratingLine{margin:3px 0 6px}.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#f1f5ff;color:#2746ff;margin-left:8px}

    #loadMoreWrap{display:flex;justify-content:center;margin:18px 0 10px}
    #loadMore{display:none;padding:10px 16px;border:0;border-radius:10px;background:#0A61FF;color:#fff;font-weight:700;cursor:pointer}
    #loadMore[disabled]{opacity:.6;cursor:not-allowed}

    /* photos row */
    .photosRow{display:grid;grid-auto-flow:column;grid-auto-columns:180px;gap:8px;overflow-x:auto;padding:8px 2px 2px;scroll-snap-type:x mandatory}
    .photosRow::-webkit-scrollbar{height:8px}.photosRow::-webkit-scrollbar-thumb{background:#e1e5ec;border-radius:999px}
    .photoCell{scroll-snap-align:start;width:180px;height:120px;border-radius:10px;overflow:hidden;background:#f3f4f6}
    .photoCell img{width:100%;height:100%;object-fit:cover;display:block}

    @media (max-width:900px){.row{grid-template-columns:1fr 1fr}.row>*{width:100%}}
  </style>
</head>
<body>
  <div class="nav"><div class="brand"><img src="logo.png" alt="AiRez"/><span>AiRez</span></div></div>

  <main>
    <div class="hero">
      <img class="hero-logo" src="logo.png" alt="AiRez mascot" />
      <h1>Real, bookable restaurants — fast</h1>
      <p class="subtitle">Describe the vibe (“cozy pasta in West Village, 8pm for 2”) and AiRez pulls realistic options with direct booking links.</p>
    </div>

    <div class="chips">
      <span class="chip">Cozy pasta</span><span class="chip">Sushi date night</span><span class="chip">Birthday dinner</span><span class="chip">Wine bars</span><span class="chip">Group spot</span>
    </div>

    <div class="panel">
      <div class="row" style="margin-bottom:10px;">
        <input id="q" placeholder="Restaurant where I can see the Hudson at sunset…" />
        <input id="party" type="number" min="1" value="2" title="Party size"/>
        <input id="date" type="date" title="Date"/>
        <input id="time" type="time" value="20:00" title="Time"/>
        <select id="where" title="Location">
          <optgroup label="NYC — Boroughs">
            <option value="Manhattan" selected>Manhattan</option><option value="Brooklyn">Brooklyn</option><option value="Queens">Queens</option><option value="Bronx">Bronx</option><option value="Staten Island">Staten Island</option>
          </optgroup>
          <optgroup label="Manhattan — Popular Areas">
            <option value="West Village">West Village</option><option value="SoHo">SoHo</option><option value="Lower East Side">Lower East Side</option><option value="Chelsea">Chelsea</option><option value="Midtown">Midtown</option><option value="Upper East Side">Upper East Side</option><option value="Upper West Side">Upper West Side</option><option value="FiDi">FiDi / Financial District</option><option value="East Village">East Village</option>
          </optgroup>
        </select>
        <button id="searchBtn" class="btn">Search</button>
      </div>

      <div id="tabs">
        <button id="tab-ai" class="tab active">AI Picks</button>
        <button id="tab-verified" class="tab">Verified Recommendations</button>
      </div>

      <label style="font-size:13px;color:#333;display:flex;align-items:center;gap:6px;">
        <input id="useAi" type="checkbox" checked/> Let Rezzie summarize results first
      </label>

      <div id="status" class="status"></div>
      <div id="aiNote"></div>
    </div>

    <div id="results"></div>
    <div id="loadMoreWrap"><button id="loadMore">Load more</button></div>
  </main>

  <!-- Concierge (unchanged UI omitted for brevity) -->
  <div id="concierge-panel" style="display:none;"></div>
  <button id="concierge-btn" style="display:none;">AI Concierge</button>

  <script>
    const API_BASE = (location.hostname === "localhost" || location.hostname === "127.0.0.1") ? "http://127.0.0.1:8088" : "";
    const API_CURSOR = API_BASE + "/api/search";
    const API_AI     = API_BASE + "/concierge/ai_chat";
    const $ = (s)=>document.querySelector(s);

    // defaults
    (function primeDate(){ const d=new Date(); $("#date").value=d.toISOString().slice(0,10); })();

    let cursor=null, isLoading=false, lastQuery="", lastCity="Manhattan", currentTab="ai";

    $("#tab-ai").onclick = ()=> switchTab("ai");
    $("#tab-verified").onclick = ()=> switchTab("verified");

    function switchTab(tab){
      currentTab = tab;
      $("#tab-ai").classList.toggle("active", tab==="ai");
      $("#tab-verified").classList.toggle("active", tab==="verified");
      cursor=null;
      clearResults();
      runSearch();
    }

    function ctxFromUI(){ return {
      q: $("#q").value.trim(),
      party: Number($("#party").value || 2),
      date: $("#date").value || null,
      time: $("#time").value || "20:00",
      city: $("#where").value || "Manhattan"
    }; }

    $("#searchBtn").addEventListener("click", () => { const ctx=ctxFromUI(); lastQuery=ctx.q; lastCity=ctx.city; cursor=null; runSearch(); });
    document.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ const ctx=ctxFromUI(); lastQuery=ctx.q; lastCity=ctx.city; cursor=null; runSearch(); }});
    $("#loadMore").addEventListener("click", ()=> loadBatch(false));

    async function runSearch(){
      const ctx = ctxFromUI();
      if (ctx.q !== lastQuery || ctx.city !== lastCity) { cursor=null; clearResults(); lastQuery=ctx.q; lastCity=ctx.city; }

      $("#status").textContent = "Searching…";
      $("#aiNote").textContent = "";
      if ($("#useAi").checked && currentTab==="ai") {
        try {
          const aiRes = await fetch(API_AI, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ message: ctx.q || "Help me find a place.", context: ctx })});
          const aiData = await aiRes.json(); if (aiData && aiData.reply) $("#aiNote").textContent = aiData.reply;
        } catch {}
      }
      await loadBatch(true);
    }

    async function loadBatch(isFirst){
      if(isLoading) return;
      isLoading = true; $("#loadMore").disabled = true;

      const params = new URLSearchParams({ q: lastQuery || $("#q").value.trim(), city: lastCity || $("#where").value || "Manhattan", tab: currentTab });
      if (cursor) params.set("cursor", cursor);

      const res = await fetch(API_CURSOR + "?" + params.toString());
      if(!res.ok){ isLoading=false; $("#loadMore").disabled=false; alert("Network error from /api/search"); return; }
      const data = await res.json();
      const items = Array.isArray(data.items) ? data.items : [];
      if (isFirst) clearResults();
      appendResults(items, currentTab==="verified");

      if (data.has_more && data.cursor){ cursor=data.cursor; $("#loadMore").style.display="inline-block"; $("#loadMore").disabled=false; }
      else { cursor=null; $("#loadMore").style.display="none"; }

      $("#status").textContent = `Tab: ${currentTab} • Showing ${document.querySelectorAll("#results .card").length}`;
      isLoading=false;
    }

    function clearResults(){ $("#results").innerHTML=""; }

    function appendResults(items, isVerified){
      const root = $("#results");
      if(!items.length && !root.children.length){
        root.innerHTML = `<div class='muted'>No matches. Try a simpler query or a nearby area.</div>`;
        return;
      }
      const html = items.map(x=>{
        const name   = x.name || "Result";
        const addr   = x.address || "";
        const rating = x.rating ? `⭐ ${x.rating}` : "";
        const yelp   = x.yelp_rating ? ` • Yelp ${x.yelp_rating}` : "";
        const price  = x.price_level ? ` • ${"$".repeat(Number(x.price_level)||0)}` : "";
        const links  = [];
        if (x.links?.opentable)   links.push(`<a href="${x.links.opentable}" target="_blank" rel="noopener noreferrer">OpenTable</a>`);
        if (x.links?.resy)        links.push(`<a href="${x.links.resy}" target="_blank" rel="noopener noreferrer">Resy</a>`);
        if (x.links?.google_maps) links.push(`<a href="${x.links.google_maps}" target="_blank" rel="noopener noreferrer">Google Maps</a>`);
        if (x.yelp_url)           links.push(`<a href="${x.yelp_url}" target="_blank" rel="noopener noreferrer">Yelp</a>`);

        const photos = Array.isArray(x.photos) ? x.photos.filter(Boolean).slice(0,9) : [];
        const photosHTML = photos.length ? (`<div class="photosRow">` + photos.map(u=>`<div class="photoCell"><img loading="lazy" src="${u}" alt=""></div>`).join("") + `</div>`) : "";

        const verifiedTop = isVerified ? `<span class="badge">VERIFIED</span>` : (x._hotspot ? `<span class="badge">hype-prone</span>` : "");
        const adminLine = isVerified && (x.admin_blurb || x.admin_reviewer)
            ? `<div class="muted" style="margin-top:6px;">${escapeHtml(x.admin_blurb || "")} ${x.admin_reviewer?`— <b>${escapeHtml(x.admin_reviewer)}</b>`:""}</div>`
            : "";

        return `
          <div class="card">
            ${photosHTML}
            <div class="title">${escapeHtml(name)} ${verifiedTop}</div>
            <div class="ratingLine">${rating}${yelp}${price}</div>
            <div class="muted">${escapeHtml(addr)}</div>
            ${adminLine}
            <div class="links" style="margin-top:8px;">${links.join(" | ") || "<span class='muted'>No links found</span>"}</div>
          </div>`;
      }).join("");
      const wrap=document.createElement("div"); wrap.innerHTML=html; while(wrap.firstChild) root.appendChild(wrap.firstChild);
    }

    function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'); }
  </script>
</body>
</html>


